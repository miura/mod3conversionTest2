\section{Step 2: Segment Nuclei}

Here, we will segment the nuclei in the image of the first channel \textbf{"C1-Small.tif"} . We would like to ignore deformed (Fig.~\ref{fig:NucDeformed}) and unusually small (Fig.~\ref{fig:NucSmall}) or large nuclei. In addition, the algorithm should identify touching nuclei (Fig.~\ref{fig:NucTwo}) so that these clusters are either ignored or properly split.

\subsection{Workflow}

We will first perform some manual processing on the image of the first channel to understand each step. After this we write a macro to perform these operations automatically (see Module 2 for an introduction of the macro programming language). Leave the command recorder open to record operations as you manually perform them.

\begin{enumerate}
    \item Select Image (make window active). 
    In Step 1 we split the channels of the original hyperstack. Now we have four independent images. To process the nuclei channel image we need to make it "active" by clicking on its window: make \textbf{"C1-Small.tif"} active.
    
    \underline{\textbf{Note} }: To select an image from a macro, we use the function \textbf{selectImage("name")} where "name" is the name of the image window. 
    Alternatively the identifier (ID) of an image can be passed to \textbf{selectImage()} . 
    This ID must first be retrieved by calling \textbf{getImageID()} at a step where the image is known to be "active".
\item Apply ``Laplacian of Gaussian'' (see Sec.~\textbf{Convolution} of Module~1 for an introduction to convolution filters ). We use a Laplacian of Gaussian (Log) filter as a preprocessing step to facilitate the segmentation (see section \ref{summary_of_tools_mod_3_step_2} for more information about the Log filter). In ImageJ this filter can be found in \ijmenu{[Plugins > Feature Extraction> FeatureJ > FeatureJ Laplacian]}.
    
    The first step of the filter is a Gaussian filter whose radius (smoothing scale) must be adjusted to the typical size of the nuclei. The next step is a Laplacian filter. When the smoothing scale is properly adjusted the nuclei appear as homogeneously dark and surrounded by a bright halo in the filtered image (see Fig.~\ref{fig:nucleiLaplacian}(b)). A rule of thumb is to set the smoothing scale to about half the expected radius of the objects. 
    
    Note, that the output of the filter is a 32 bit image since the intensity values can be negative or positive. FeatureJ Laplacian can also detect zero-crossings, where the intensity changes sign (close to a sharp intensity transition), but we will not use this feature here (leave unticked). Make sure that "Compute Laplacian image" is ticked.
    
    To better understand the advantage of using a Laplacian prefiltering, you can try to directly apply a threshold on the original nuclei image.
    