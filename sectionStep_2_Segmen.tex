\section{Step 2: Segment Nuclei}

Here, we will segment the nuclei in the image of the first channel \textbf{"C1-Small.tif"} . We would like to ignore deformed (Fig.~\ref{fig:nucleiShapes}d) and unusually small (Fig.~\ref{fig:nucleiShapes}b) or large nuclei. In addition, the algorithm should identify touching nuclei (Fig.~\ref{fig:nucleiShapes}c) so that these clusters are either ignored or properly split.

\subsection{Workflow}

We will first perform some manual processing on the image of the first channel to understand each step. After this we write a macro to perform these operations automatically (see Module 2 for an introduction of the macro programming language). Leave the command recorder open to record operations as you manually perform them.

\begin{enumerate}
    \item Select Image (make window active). 
    In Step 1 we split the channels of the original hyperstack. Now we have four independent images. To process the nuclei channel image we need to make it "active" by clicking on its window: make \textbf{"C1-Small.tif"} active.
    
    \underline{\textbf{Note} }: To select an image from a macro, we use the function \textbf{selectImage("name")} where "name" is the name of the image window. 
    Alternatively the identifier (ID) of an image can be passed to \textbf{selectImage()} . 
    This ID must first be retrieved by calling \textbf{getImageID()} at a step where the image is known to be "active".
\item Apply ``Laplacian of Gaussian'' (see Sec.~\textbf{Convolution} of Module~1 for an introduction to convolution filters ). We use a Laplacian of Gaussian (Log) filter as a preprocessing step to facilitate the segmentation (see section \ref{summary_of_tools_mod_3_step_2} for more information about the Log filter). In ImageJ this filter can be found in \ijmenu{[Plugins > Feature Extraction> FeatureJ > FeatureJ Laplacian]}.
    
    The first step of the filter is a Gaussian filter whose radius (smoothing scale) must be adjusted to the typical size of the nuclei. The next step is a Laplacian filter. When the smoothing scale is properly adjusted the nuclei appear as homogeneously dark and surrounded by a bright halo in the filtered image (see Fig.~\ref{fig:nucleiLaplacian}(b)). A rule of thumb is to set the smoothing scale to about half the expected radius of the objects. 
    
    Note, that the output of the filter is a 32 bit image since the intensity values can be negative or positive. FeatureJ Laplacian can also detect zero-crossings, where the intensity changes sign (close to a sharp intensity transition), but we will not use this feature here (leave unticked). Make sure that "Compute Laplacian image" is ticked.
    
    To better understand the advantage of using a Laplacian prefiltering, you can try to directly apply a threshold on the original nuclei image.
In Fig.~\ref{fig:nucleiLaplacian} we can observe the result of the LoG filter performed on the nuclei image. The shapes of the nuclei are nicely mimicked in rings of different intensities (Fig.~\ref{fig:nucleiLaplacian}), as it can be visualized by changing the LUT to a colored LUT (\ijmenu{[Image> LookUp Tables]} to get the list of available LUTs). Try to optimize the smoothing scale of FeatureJ Laplacian to obtain a result similar to \ref{fig:nucleiLaplacian}.

\item Set threshold and convert to mask. 
    Here, we will convert this image into a binary image by thresholding (see section on \textbf{thresholding} in Module 1). We need to set the bounds of the threshold to separate the nuclei from the background. To achieve this, we use the command:
   
    \ijmenu{[Image >  Adjust > Threshold...]}
    
    Make sure to un-tick "Dark Bakground" and "set background pixels to NaN" (appears as pop-up window when clicking "Apply"), to obtain a regular 8-bit binary image (mask). Thanks to the preprocessing the nuclei can now readily be segmented by thresholding the pixels with negative values (up to a small negative value) in the filtered image. 
    The results is a black and white image, in which all pixels that belong to an object have an intensity value of 255, while all pixels that belong to the background have an intensity value of 0. 
    
    \textbf{\underline{Note}} : After converting the image to binary ImageJ automatically applies (by default) a LUT inversion: The objects now appear black on a white background. See also  \url{http://imagej.nih.gov/ij/docs/guide/146-29.html#infobox:InvertedLutMask}

\item Fill holes
    \ijmenu{[Process >  Binary > Fill Holes]}.
    Some objects of the binary image might have holes (see Fig.~\ref{fig:NucFillHoles}). A hole is defined as a group of pixels belonging to the background (white pixels) surrounded by pixels belonging to the foreground (black pixels). Since we do not expect the nuclei to exhibit any hole, we use \ijmenu{[Process > Binary > Fill Holes]} to fill them in (see section \textbf{Morphology} in Module 1).  
\item Dilate
    \ijmenu{[Process >  Binary > Dilate]}.
    From Fig.~\ref{fig:NucOverlayBeforeDilate} we can see that the detected boundaries mostly follow the contours of the nuclei but that they sometimes overlap with them. This may become a problem later on when intending to detect a FISH spot close to the boundary of a nucleus. This problem can be mitigated by enlarging the segmented nuclei by morphological dilation (see section \textbf{Morphology} in Module 1). Each round of dilation enlarges the objects by one pixel, several dilations can be performed sequentially. 
\item Watershed
    \ijmenu{[Process >  Binary > Watershed]}.
    Try the binary watershed command to separate touching nuclei.
\item Analyze Particles.
    At this point we obtained a binary image holding the segmented nuclei.
    Using \ijmenu{[Analyze > Analyze Particle]} we can identify and measure several properties of these connected particles. This command also allows us to exclude an object based on its geometry. For our purpose,  we want to exclude deformed particles and particles that are too small or too big.
    
    To exclude deformed particles, we can measure their circularity. The circularity describes how closely an object resembles a circle by computing the ratio between its area and its square perimeter. A perfect circle has a circularity parameter = 1. Any other object will have a circularity parameter smaller than 1, but greater than 0 (an infinite line). 
    
    Particles that are smaller or larger than given critical areas can also be excluded. The area bounds should be first determined empirically: you can do so by measuring the area of a typical nucleus and setting the lower and upper bounds to, for instance 0.66x and 1.5x this value. 
    
    Finally, particles touching a border can be easily discarded by ticking "Exclude on edges" in \ijmenu{[Analyze > Analyze Particles...]}. The purpose is to analyse FISH spots by nucleus, do not forget to also tick 'Add to Manager' to add the nuclei analyzed to the ROI Manager so that they can easily be accessed further on.

\end{enumerate}    